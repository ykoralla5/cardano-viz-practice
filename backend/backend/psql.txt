Summary tables

delegation_summary: get all delegations in all epochs

CREATE TABLE IF NOT EXISTS delegation_summary (
    delegation_id BIGINT NOT NULL,
    epoch_no BIGINT NOT NULL,
    slot_no word63type NOT NULL,
    tx_id BIGINT NOT NULL,
    addr_id BIGINT NOT NULL,
    source_pool_id BIGINT,
    destination_pool_id BIGINT,
    amount lovelace,
    last_epoch word31type,
    movement_type TEXT,
    computed_at TIMESTAMP DEFAULT now(),
    PRIMARY KEY (epoch_no, tx_id, addr_id, delegation_id)
);

CREATE TABLE IF NOT EXISTS pool_perf_summary (
    epoch_no word31type,
    pool_id BIGINT,
    actual_blocks BIGINT,
    expected_blocks NUMERIC(20,5),
    created_at TIMESTAMPTZ DEFAULT NOW(),
    PRIMARY KEY (epoch_no, pool_id)
);

CREATE TABLE IF NOT EXISTS pool_stats_summary (
    epoch_no word31type,
    pool_id BIGINT,
    pool_view TEXT,
    total_stake NUMERIC(20, 5),
    delegator_count BIGINT,
    pledge lovelace,
    is_active BOOLEAN,
    saturation_ratio NUMERIC(20, 10),
    created_at TIMESTAMPTZ DEFAULT NOW(),
    PRIMARY KEY (epoch_no, pool_id)
);

SELECT cron.schedule(
    'update_delegation_summary',  -- job name
    '*/5 * * * *',               -- every 5 minutes
$$
INSERT INTO delegation_summary (
    delegation_id,
    epoch_no,
    slot_no,
    tx_id,
    addr_id,
    source_pool_id,
    destination_pool_id,
    amount,
    last_epoch,
    movement_type
)
WITH delegation_with_prev AS (
    SELECT
        d.id AS delegation_id,
        d.addr_id,
        d.pool_hash_id AS dest_pool_id,
        tx.id AS tx_id,
        d.active_epoch_no AS epoch_no,
        b.slot_no,
        tx.hash AS tx_hash,
        LAG(d.pool_hash_id) OVER (
            PARTITION BY d.addr_id
            ORDER BY d.active_epoch_no, b.slot_no, tx.id
        ) AS prev_pool_id
    FROM delegation d
    JOIN tx ON tx.id = d.tx_id
    JOIN block b ON b.id = tx.block_id
)
SELECT
    dw.delegation_id,
    dw.epoch_no,
    dw.slot_no,
    dw.tx_id,
    dw.addr_id,
    dw.prev_pool_id AS source_pool_id,
    dw.dest_pool_id AS destination_pool_id,
    es_prev.amount,
    es_prev.epoch_no AS last_epoch,
    CASE
        WHEN dw.prev_pool_id IS NULL AND dw.dest_pool_id IS NOT NULL THEN ''NEW_STAKE''
        WHEN dw.prev_pool_id IS NOT NULL AND dw.dest_pool_id IS NULL THEN ''UNDELEGATED''
        WHEN dw.prev_pool_id IS NOT NULL AND dw.dest_pool_id IS NOT NULL AND dw.prev_pool_id <> dw.dest_pool_id AND es_prev.amount IS NULL THEN ''AWAITING_ACTIVATION''
        WHEN dw.prev_pool_id IS NOT NULL AND dw.dest_pool_id IS NOT NULL AND dw.prev_pool_id <> dw.dest_pool_id THEN ''REDELEGATION''
        ELSE ''NO_CHANGE''
    END AS movement_type
FROM delegation_with_prev dw
LEFT JOIN LATERAL (
    SELECT es.epoch_no, es.amount
    FROM epoch_stake es
    WHERE es.addr_id = dw.addr_id
      AND es.epoch_no <= dw.epoch_no - 2
    ORDER BY es.epoch_no DESC
    LIMIT 1
) es_prev ON TRUE
ORDER BY dw.epoch_no, dw.slot_no
ON CONFLICT (epoch_no, tx_id, addr_id, delegation_id)
DO NOTHING;
$$
);

sudo touch logs/delegation_summary.log
sudo touch logs/pool_expected_blocks_summary.log
sudo touch logs/pool_epoch_stake_summary.log
sudo chown postgres:postgres logs/*.log

sudo -u postgres crontab -e
ADD the lines:
*/5 * * * * echo "----- $(date) -----" >> /home/cardano-viz/psql_incremental_updates/logs/delegation.log && psql -d cardano_db_filtered -f /home/matija/cardano-viz-practice/psql_incremental_updates/update_delegation.sql >> /home/matija/cardano-viz-practice/psql_incremental_updates/logs/delegation.log 2>&1

*/5 * * * * echo "----- $(date) -----" >> /home/cardano-viz-practice/psql_incremental_updates/logs/pool_stats.log && psql -d cardano_db_filtered -f /home/matija/cardano-viz-practice/psql_incremental_updates/update_pool_stats.sql >> /home/matija/cardano-viz-practice/psql_incremental_updates/logs/pool_stats.log 2>&1

*/5 * * * * echo "----- $(date) -----" >> /home/cardano-viz-practice/psql_incremental_updates/logs/pool_perf.log && psql -d cardano_db_filtered -f /home/matija/cardano-viz-practice/psql_incremental_updates/update_pool_perf.sql >> /home/matija/cardano-viz-practice/psql_incremental_updates/logs/pool_perf.log 2>&1


/home/cardano-viz-practice/psql_incremental_updates/logs/*.log {
	daily
	rotate 8
	compress
	delaycompress
    	missingok
    	notifempty
	create 640 postgres postgres
}

Done:

-- Index for filtering by epoch (incremental insert)
CREATE INDEX idx_pool_stats_epoch ON pool_stats_summary(epoch_no);

-- Index for incremental updates / filtering by epoch
CREATE INDEX idx_pool_perf_epoch ON pool_perf_summary(epoch_no);

-- Index for filtering by epoch
CREATE INDEX idx_delegation_epoch ON delegation_summary(epoch_no);

-- Optional: index by pool if you query per pool often
CREATE INDEX idx_pool_stats_pool ON pool_stats_summary(pool_id);

---------------------------------------------------------------------------





-- Optional: index by pool
CREATE INDEX idx_pool_perf_pool ON pool_perf_summary(pool_id);



-- Index for filtering by pool
CREATE INDEX idx_delegation_source_pool ON delegation_summary(source_pool_id);
CREATE INDEX idx_delegation_dest_pool ON delegation_summary(destination_pool_id);